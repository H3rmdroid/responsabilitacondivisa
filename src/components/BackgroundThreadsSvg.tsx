import { motion, useScroll, useTransform } from "motion/react";
import { useRef, useEffect } from "react";
import { useIsDesktop } from "../hooks/useIsDesktop";
import { getBackgroundLayout } from "../layout/backgroundLayout";

export function BackgroundThreadsSvg() {
  const containerRef = useRef<HTMLDivElement>(null);
  const isDesktop = useIsDesktop();
  const { threadsSvg: layoutConfig } = getBackgroundLayout(isDesktop);
  const delayScale = isDesktop ? 1 : 1;
  const durationScale = isDesktop ? 1 : 1;
  const baseDelay = isDesktop ? 0 : 0;
  type ScrollOffset = NonNullable<Parameters<typeof useScroll>[0]>["offset"];
  const offset: ScrollOffset = isDesktop
    ? ["start 30%", "end 1%"]
    : ["start 110%", "end 1%"];
  
  // Scroll progress per l'SVG dalla sezione quiz
  const { scrollYProgress } = useScroll({
    target: containerRef,
    offset
  });

  // Debug
  useEffect(() => {
    const unsubscribe = scrollYProgress.on("change", () => {});

    return () => {
      unsubscribe();
    };
  }, [scrollYProgress]);

  // OpacitÃ  globale dell'SVG che va da 0 a 1 - inizia quando l'SVG entra in viewport
  const svgOpacity = useTransform(scrollYProgress, [0, 0.01], [0, 1]);

  // Funzione per creare l'animazione dei path dall'alto verso il basso
  const createPathAnimation = (delay = 0, duration = 0.2) => {
    const effectiveDuration = duration === 0 ? 0.2 : duration;
    const scaledDelay = delay * delayScale;
    const scaledDuration = effectiveDuration * durationScale;
    const endPoint = Math.min(scaledDelay + scaledDuration, layoutConfig.pathCap);
    return useTransform(scrollYProgress, [scaledDelay, endPoint], [0, 1]);
  };
  const createPathStyle = (delay = 0, duration = 0.2) => {
    const progress = createPathAnimation(baseDelay + delay, duration);
    return { pathLength: progress };
  };


    const firstPathdelay = isDesktop ? 0.1 : 0.2;
    const firstPathDuration = isDesktop ? 0.4 : 0.1;

    const secondPathDelay = isDesktop ? 0.5 : 0.3;
    const secondPathDuration = isDesktop ? 0.5 : 0.1;

    const thirdPathdelay = isDesktop ? 0.8 : 0.34;
    const thirdPathDuration = isDesktop ? 0.2 : 0.3;


  

  return (
    <div 
      ref={containerRef} 
      style={{ 
        position: "absolute", 
        top: layoutConfig.containerTop,
        left: layoutConfig.containerLeft,
        right: layoutConfig.containerRight,
        height: layoutConfig.containerHeight, // Sincronizzato con QuizWrapper
        zIndex: 0,
        pointerEvents: "none",
        outline: "none",
        backgroundColor: "transparent",
      }}
    >
      <motion.div
        className="sticky top-0 h-screen overflow-visible"
        style={{ 
          opacity: svgOpacity
        }}
      >
        <svg
          id="background-threads-svg"
          data-name="Layer 1"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 2100 393.34 1200"
          style={{
            position: "absolute",
            top: layoutConfig.svgTop,
            left: layoutConfig.svgLeft,
            width: layoutConfig.svgWidth,
            height: "auto",
            transform: layoutConfig.svgTransform,
            transformOrigin: layoutConfig.svgTransformOrigin,
            zIndex: 0,
            pointerEvents: "none",
          }}
          preserveAspectRatio="xMidYStart meet"
        >
          <defs>
            <style>
              {`
                #background-threads-svg .cls-1 {
                  fill: none;
                  stroke: #232322;
                  stroke-miterlimit: 10;
                  stroke-width: .7px;
                }
              `}
            </style>
          </defs>
          
          {/* Ordinati dall'alto verso il basso in base alla coordinata Y iniziale */}
          <motion.path
            className="cls-1"
            d="M393.17,2244.28c-8.85-.69-11.12-.47-16.01-.16-4.16.27-5.43.56-19.59,1.76-4.98.42-8.07.67-12.25.69-4.96.02-9.05-.27-11.9-.56,0,0-.33-.18-.6-.38-2.33-1.89-.98-4.74-1.76-9.43-1.27-7.74-7.36-14.43-9.92-13.83-2.45.56-2.31,7.81-5.58,12.23-1.91,2.58-2.36,3.05-2.36,3.05-1.45,1.51-2.45,2.02-2.36,2.85.07.67.8.87,2.09,1.89.62.49,2.89,2.27,2.6,3.18-.36,1.13-4.54.62-13.52.53-6.25-.07-7.98.13-8.67-.96-.96-1.51,1.31-3.65,4.29-8.29,3.02-4.71,5.65-8.78,6.32-13.5.98-6.83-3.69-7.61-1.96-14.83,2-8.29,3.58-10.63,3.58-10.63.87-1.29,2.02-2.69,1.47-3.62-.76-1.22-3.58.31-6.58-1.05-2.56-1.16-3.74-3.76-4.85-6.2-2.13-4.69-1.02-6.72-2.54-8.23-3.38-3.4-13.88,2-14.7,2.4-40.94,20.88-166.72,19.3-175.39,16.32-2.49-.85-4.65-2.8-4.65-2.8-1.13-1.02-3.85-3.49-3.07-5.49.62-1.62,3.34-2.47,5.45-1.78,1.53.51,2.91,1.89,3.18,3.6.16,1.07-.04,2.74-1.05,3.29-.58.31-1.27.11-2.65-.29-1.25-.38-2.2-.85-3.36-1.4-1.13-.56-1.67-.89-2.74-1.22-.56-.18-.85-.2-1.42-.36-1.67-.44-4.54-1.33-6.65-2.78-1.11-.76-1.02-.96-2.85-2.8-4.56-4.58-6.65-4.45-6.87-6.27-.27-2.36,3.25-2.87,4.43-7,.2-.69,1.13-4.27-1.02-7.14-1.67-2.22-4.85-3.49-7.45-2.62,0,0-2.42.8-4,3.51-.36.6-.6,1.2-.6,1.2,0,0-.27.64-.58,1.58l-.04.16h0l-.04.11c-.4,1.25-3.02,1.85-3.02,1.85-4.67,1.05-8.54,4.85-9.54,5.96-.53.62-1,1.33-.85,2.02.16.6.76.93.82.98,1.18.6,2.27-.58,4.07-.78,1.58-.18,2.87.47,3.76.93,3.47,1.8,4.36,5.83,4.49,6.47,0,0,3.29,4.69,3.6,4.96.09.07.16.13.16.13.11.09.2.13.22.16.18.11.53.38.78.58,3.16,2.38,4.6,3.82,4.6,3.82.89.87,1.4,1.4,2,2.25.93,1.33,1.98,2.82,1.73,4.47-.18,1.2-1.02,2.33-1.96,2.89-.71.42-2.45,1.09-11.47-4-1.73-.98-7.85-4.49-10.61-8.32-1.02-1.42-1.62-2.76-1.62-2.76-.36-.8-.96-2.13-1.22-3.98-.24-1.6-.09-2.58-.87-3.36-.09-.09-.51-.49-.98-.56-1.85-.22-3.94,5.09-4.29,5.98-1.45,3.67-4.45,11.27-1.76,20.01,2.42,7.85,8.05,12.03,6.65,13.74-.98,1.18-5.07.91-6.85.56-.07,0-.11-.02-.11-.02-2.49-.51-3.14-1.31-4.38-1,0,0-.09,0-.22.07-2.42.78-4.03,5.58-4.25,6.27-2.05,6.29-3.07,9.45-2.07,10.07.85.53,2.89-.78,5.11-2.2.22-.16.96-.62,1.98-1.25.8-.49,1.49-.87,1.62-.93,2.07-1.13,5.36,1.25,9.34,1.45,3.45.18,6.12-1.36,7-1.93,0,0,3.29-2.09,4.8-5.56.31-.73.58-1.56.58-1.56.4-1.22.53-2.18.56-2.29.42-2.49,11.5-12.14,15.3-9.16,1.85,1.45,1.67,5.69.4,8.45-1.56,3.38-4.31,3.54-4.87,6.78-.27,1.53-.04,3.85,1.29,5.34.82.93,1.53.96,3,2.36,1.22,1.18,2.09,2.02,2,2.71-.4,2.74-16.41,4.05-17.52.51-.36-1.11,1.02-2,.69-2.74-1.13-2.6-20.35,4.11-28.78,6.27-12.34,3.16-16.75,3.74-36.17-7"
            style={createPathStyle(firstPathdelay, firstPathDuration)}
          />
          <motion.path
            className="cls-1"
            d="M22.31,2246.61c5.16,1.98,12.61,5.65,19.3,12.54,11.85,12.23,15.92,29.09,16.12,57.42.31,41.83-8.27,41.1-7.41,70.74,1.49,50.61,27.37,82.99,25.13,107.21-.09.91-1.18,12.34,4.6,20.73.49.71,4.14,5.94,6.16,5.14.96-.38,1.4-1.8,1.42-1.91.36-1.2-.07-2.25-.27-2.78-.78-1.93-2.51-2.78-2.96-3-.29-.13-1.69-.8-3.62-.58-2.78.29-4.74,4.67-8.38,5.36-2.36.47-2.31-1.25-10.52-4.25-2.31-.85-3.36-1.09-3.74-2.09-.76-1.98,2.45-3.6,2.71-7.56.04-.56.2-3.05-1.47-4.91-1.71-1.93-4.54-2.29-6.58-1.8-2.58.62-4.03,2.65-4.76,3.62-1.98,2.74-1.2,4.23-2.71,5.92-2,2.22-4.65,1-8.27,2.05-6.12,1.78-11.92,8.47-11.54,14.97.22,3.82,2.51,6.56,3.56,7.81,3.56,4.25,8.41,5.47,9.63,5.74,4.31.96,5.4-.64,8.72.98,2.67,1.29,3.54,3.02,5.69,2.91,1.62-.09,3.34-1.2,3.94-2.71,1.13-2.85-2.11-6.18-3.4-7.52-2.74-2.8-5.85-3.78-7.21-4.2-4.45-1.33-8.25-.64-9.96-.22-1.56.4-5.09,1.31-8.16,4.38-.78.78-6.2,6.34-4.67,12.88,1.11,4.76,5.27,7.23,9.3,9.54,3.62,2.09,8.58,3.96,9.05,3.16.53-.91-2.94-5.38-7.07-5.65-2.85-.18-3.62,1.82-6.6,1.58-3.38-.29-4.14-3.02-6.74-3.29-3.67-.38-5.98,4.63-9.07,7.47-6.74,6.16-7.37,1.1-12.36.49"
            style={createPathStyle(secondPathDelay, secondPathDuration)}
          />
          <motion.path
            className="cls-1"
            d="M393.17,2519.34c-12.26-6.81-19.63-5.05-27.04-1.98-2.67,1.11-9.81,4.51-15.19,1.67-3.91-2.09-5.52-6.72-9.36-6.49-.22,0-1.58.11-2.62,1.09-2.45,2.31-.69,7.27-.6,7.52,1.05,2.85,2.65,3.22,7.18,7.27,3.74,3.36,7.36,6.67,9.61,11.79.87,2,1.45,4.05,1.53,4.43,1.53,5.65.27,6.76,1.93,9.25.98,1.49,2.25,2.31,3.4,4.94.44,1.02.69,1.53.53,1.89-.73,1.8-7.52-.36-18.81-1.13-1.16-.09-7.65-.51-15.54-.04-1.29.07-2.38.16-3.56.27,0,0-1.09.11-2.2.27-5.18.69-7.76,1.05-14.74,2.89-4.48,1.18-9.96,1.94-15.76,2.39-19.91,1.55-43.61-.41-43.61-.41-70.52-5.85-105.79-8.76-128.05-6.2-17.39,2-61.93,8.81-62.53,5.8-.16-.8,2.65-2.27,2.94-5.56.13-1.49-.38-2.94.42-3.56.51-.4,1.13-.16,1.85-.09,2.47.2,5.36-1.82,6.49-4.25,1.13-2.45.27-4.91-.13-6.12-.62-1.82-1.67-3.11-3.4-5.2-1.49-1.82-1.58-1.58-2.49-2.76-3.02-3.91-3.58-8.61-2.62-11.5.13-.42.22-.56.33-.64,1.42-1.36,5.2,3.27,10.83,3.2,3.09-.02,6.27-1.49,7.32-2.05.98-.51,1.67-.93,2.2-1.29.85-.56,1.16-.89,1.85-1.13.49-.22,1.2-.42,1.98-.27,1.67.31,4.29,4.8,5.31,10.47,4.91,26.89-2.78,64.09-2.78,64.09-3.14,15.17-5.38,37.54,0,66.96,5.63,16.36,11.25,32.71,16.88,49.07,12.91,62.85,14.26,90.25,12.57,103.23-.22,1.69-1.35,9.87-2.16,21.14-.6,8.39-1.01,18.69-.75,30.38.36,16.3,1.76,23.86,2.91,39.07.47,6.2,1.58,22.44.02,67.78-2.67,77.79-8.49,93.95,3.27,120.31,4.05,9.1,16.68,33.45,25.8,31.96.85-.13,4.78-1,4.94-2.62.13-1.45-2.69-3.45-5.31-3.22-1.98.18-3.25,1.56-3.51,1.87-1.22,1.36-1.49,2.89-1.62,3.82-.56,3.65.85,8.23,4.36,11.03.85.67,3.42,2.76,6.43,2.38,1.11-.13,1.16-.47,3.49-.93,2.13-.42,3.4-.4,3.71-1.16.13-.38-.11-.53-.11-1.89,0,0,0-.62.04-1.18.07-.96.18-2.33.89-3.56.53-.91,1.65-2.11,3.38-2.51,1.91-.44,3.45.4,3.91.67.36.2,1.42.82,2.13,2.11.8,1.45.71,2.94.69,3.51-.04.98-.27,1.29-.18,2.25.04.42.13,1.36.58,2.05.96,1.4,2.85.67,6.43,1.82.62.2,1.85.6,3.16,1.42.18.11,2.36,1.49,3.98,3.89.49.71,4.27,6.45,1.96,11.79-1.91,4.4-6.74,5.67-11.14,6.8-2.36.62-9.83,2.56-11.9-.67-1.11-1.73-.31-4.38.8-5.94,2.56-3.54,7.89-2.87,9.16-2.71,5.09.64,9.83,4.4,11.1,9.12.38,1.38.38,2.56.36,3.09-.18,5.54-4.71,8.63-3.87,9.78.93,1.29,6.49-2.47,9.16-.16.24.2.56.76,1.16,1.87,1.33,2.47,2.11,4.38,2.78,6.05,2.16,5.31,2.49,5.76,2.13,6.16-.89,1.07-4.36-.36-7.23-1.53-3.87-1.6-3.69-2.22-5.94-2.82-3.25-.87-6.23-.2-9.36.47-2.89.6-4.63,1.42-7.87,1.25-1.18-.07-1.8-.09-2.62-.4-2.91-1.07-5.4-4.43-5.09-7.83.24-2.8,2.29-4.56,3.71-5.76,1-.87,3.42-2.69,8.98-3.67,5.8-1.02,10.59-.33,11.88-.11.13.02.24.04.29.04,2.51.44,48.39,8.72,60.91,10.45,21.28,2.94,26.42-1.91,59.15-4.23,18.55-1.31,57.16-1.82,90.92,2.82"
            style={createPathStyle(thirdPathdelay, thirdPathDuration)}
          />
        </svg>
      </motion.div>
    </div>
  );
}
