import { motion, useScroll, useTransform } from "motion/react";
import { useRef, useEffect } from "react";
import { useIsDesktop } from "../hooks/useIsDesktop";
import { getBackgroundLayout } from "../layout/backgroundLayout";

export function BackgroundThreadsSvg2() {
  const containerRef = useRef<HTMLDivElement>(null);
  const isDesktop = useIsDesktop();
  const { threadsSvg2: layoutConfig } = getBackgroundLayout(isDesktop);
  const delayScale = isDesktop ? 1 : 1;
  const durationScale = isDesktop ? 1 : 1;
  
  // Scroll progress per l'SVG dalla sezione quiz
  const { scrollYProgress } = useScroll({
    target: containerRef,
    offset: isDesktop
      ? (["start 100%", "end 100%"] as const)
      : (["start 100%", "end 100%"] as const),
  });

  // Debug
  useEffect(() => {
    const unsubscribe = scrollYProgress.on("change", (latest) => {
      console.log("ðŸ§µ Threads SVG 2 Progress:", latest.toFixed(2));
    });

    return () => {
      unsubscribe();
    };
  }, [scrollYProgress]);

  // OpacitÃ  globale dell'SVG che va da 0 a 1 - inizia quando l'SVG entra in viewport
  const svgOpacity = useTransform(scrollYProgress, () => 1);

  // Funzione per creare l'animazione dei path dall'alto verso il basso - completata al 35%
  const createPathAnimation = (delay = 0, duration = 0.2) => {
    const effectiveDuration = duration === 0 ? 0.2 : duration;
    const scaledDelay = delay * delayScale;
    const scaledDuration = effectiveDuration * durationScale;
    const endPoint = Math.min(scaledDelay + scaledDuration, layoutConfig.pathCap);
    return useTransform(scrollYProgress, [scaledDelay, endPoint], [0, 1]);
  };

  return (
    <div 
      ref={containerRef} 
      style={{ 
        position: "absolute", 
        top: layoutConfig.containerTop,
        left: layoutConfig.containerLeft,
        right: layoutConfig.containerRight,
        height: layoutConfig.containerHeight,
        zIndex: 0,
        pointerEvents: "none",
        outline: "none",
        backgroundColor: "transparent",
      }}
    >
      <motion.div
        className="relative"
        style={{ opacity: svgOpacity, position: "relative", height: "100%", overflow: "visible" }}
      >
        <svg
          id="background-threads-svg-2"
          data-name="Layer 1"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 2550 393.34 900"
          style={{
            position: "absolute",
            top: layoutConfig.svgTop,
            left: layoutConfig.svgLeft,
            right: layoutConfig.svgRight,
            width: layoutConfig.svgWidth,
            transform: layoutConfig.svgTransform,
            height: "auto",
            transformOrigin: layoutConfig.svgTransformOrigin,
            zIndex: 0,
            pointerEvents: "none",
          }}
          preserveAspectRatio={layoutConfig.svgPreserveAspectRatio}
        >
          <defs>
            <style>
              {`
                #background-threads-svg-2 .cls-1 {
                  fill: none;
                  stroke: #232322;
                  stroke-miterlimit: 10;
                  stroke-width: .7px;
                }
              `}
            </style>
          </defs>
          
          {/* Ordinati dall'alto verso il basso in base alla coordinata Y iniziale */}
          <motion.path
            className="cls-1"
            d="M.17,2783.43c45.83,6.8,47.5,5.92,56.82,3.36.56-.16,7.03-2.09,15.5-1.36,5.94.51,16.48,1.42,19.12,7.92,1.67,4.11-.49,8.92-1.11,10.27-2.65,5.85-7.05,6.38-7.36,11.05-.13,2.2.69,4.98,2.6,6.78,1.31,1.25,2.8,1.71,3.11,1.8,2.58.78,4.03-.27,6.94.69.29.09,1.18.4,2,.93,2.89,1.8,4.74,6.07,4.25,9.74-.73,5.63-7.52,8.74-6.36,10.94.24.47.71.64,1.89,2.27.27.38.73,1,1.16,1.76.98,1.71,1.78,3.11,1.4,3.91-.56,1.13-3.2.4-9.74-.13-4.91-.4-6.58-.29-7.07-1.25-.8-1.56,2.13-3.07,2.76-7.36.11-.8.82-5.51-1.96-7.72-1.4-1.11-3.74-1.58-4.78-.64-1.18,1.07-.33,3.47-.04,5.09,1.6,9.03-9.78,15.97-7.87,19.75,1.62,3.18,11.01,1.27,19.12.44,16.37-1.67,24.22,1.58,39.16,3.29,21.33,2.42,42.81-6.98,76.01-5.27,30.82,1.58,84.24,15.79,94.82,14.03,1.82-.31,8.81-2.16,11.65-6.16.4-.56,1.58-2.33,2.56-8.56,1.71-10.96-.73-13.3,1.69-19.39,1.45-3.65,2.11-2.33,5.69-9.1,3.42-6.45,4.49-10.83,4.85-12.41.29-1.33.78-3.51.98-6.43.27-4-.27-5.96.53-9.94.56-2.74,1.22-3.8,2.05-4.51.82-.71,1.49-.78,2.62-1.8.87-.78,2.16-1.96,1.98-2.89-.31-1.53-4.51-1.78-9.63-2.07-4.27-.24-5.47.09-6.23.96-.6.69-.49,1.22-.96,4.07-.11.71-.6,3.49-1.2,5.54-.73,2.51-1.2,2.33-2.82,6.03-1.96,4.45-2.02,6.43-3.49,6.76-.87.2-1.67-.29-2.96-1.13-.42-.27-3.4-2.25-4.29-4.65-1.4-3.85,3.47-6.52,6.8-15.19,1.53-3.98,2.91-7.74,1.51-11.81-1.07-3.09-3.76-6.27-7.32-7.03-2.02-.42-4.94-.2-5.49,1.16-.71,1.76,2.87,4.71,3.96,5.6,8.47,6.98,22.26,5.6,24.84,5.36,12.21-1.13,39.57-1.05,65.3,1.98"
            style={{ pathLength: createPathAnimation(0, 0) }}
          />
          <motion.path
            className="cls-1"
            d="M.17,2866.91c8.58,0,27.73,1.02,40.25.16,1.02-.07,9.01-.71,11.07-4.71.13-.27.4-.85.91-2.02,1.58-3.51,1.67-4.09,2.47-5.83,3.16-6.89,4.23-8.05,3.85-10.47-.51-3.16-2.71-3.58-3-7.32-.22-2.98,1.05-4.58.27-5.27-1.33-1.18-6.03,1.69-8.38,3.62-2.07,1.69-8.01,7.34-9.32,25.86-.58,8.09-.42,20.97,4.49,36.56,3.71,16.37,4.34,29.78,4.18,39.16-.29,18.44-3.62,24.77-2.8,44.92.71,17.15,3.25,15.63,2.76,28.33-.53,13.43-1.42,35.67-13.65,43.43-.78.49-7.83,4.87-10.85,11.34-1.38,2.96-.78,4-.53,4.34.8,1.09,2.91,1.36,4.36.38.93-.62,1.58-1.78,1.49-2.94-.16-2.07-2.54-3.11-2.94-3.27-3.85-1.6-8.52,1.78-8.92,2.09-2.65,1.98-3.16,3.96-4.38,3.74-1.47-.27-.91-3.2-3.38-5.85-2.29-2.45-4.63-1.93-5.07-3.62-.53-2.02,2.71-3.09,3.09-6.47.24-2.29-3.31-5.45-5.96-6.49"
            style={{ pathLength: createPathAnimation(0, 0) }}
          />
          <motion.path
            className="cls-1"
            d="M393.17,2870.98c-33.96,5.25-67.44,6.54-81.36,6.8-4.96.09-25.44.38-26.95-5.38-.24-.91-.16-2.6.73-3.87,1.31-1.8,3.49-1.58,8.32-2.67,4.29-.96,6.43-1.45,7.54-2.65,1.93-2.07.47-3.51,2.16-10.39.18-.73.62-2.49-.27-3.8-.07-.11-.69-1.02-1.2-.89-1.07.27.56,4.74-1.67,7.94-1.11,1.6-3.16,2.82-5.45,2.8-2.16-.04-4.43-1.22-5.4-3.18-1.53-3.05.64-6.8.96-7.32.98-1.69,1.91-2.07,2.02-3.51.11-1.65-1.07-1.98-1.27-3.82-.29-2.78,2.11-4.89,1.6-5.34-.29-.27-1.29.24-2.22.98-3.36,2.71-2.47,6.2-4.85,9.32-1.82,2.38-4.94,3.78-7.16,3.78-5.89,0-10.9-9.25-13.01-15.28-7.81-22.17,11.27-35.05,7.05-64.45-.43-2.94-1.09-6.16-1.4-10.48,0,0-.18-2.85-.16-5.86.05-5.95,3.64-24.15,10.67-48.19,3.98-16.94,7.45-36.19,9.58-57.45,3.1-31.02,2.56-58.85.58-82.09"
            style={{ pathLength: createPathAnimation(0, 0) }}
          />
          <motion.path
            className="cls-1"
            d="M.17,2948.63c19.64,1.51,34.2,3.45,71.94,3.94,67.29.89,76.28-3.87,137.32-2.05,45.79,1.36,56.86,4.51,100.92,3.91,30.71-.4,66.24-2.33,82.83-3.91"
            style={{ pathLength: createPathAnimation(0, 0) }}
          />
          <motion.path
            className="cls-1"
            d="M.17,3021.82c56.46,5.47,85.79,4.18,117.48,1.85,52.99-3.89,106.23,5.96,159.33,4.65,4.63-.11,17.99-.58,22.77,6.87,2.38,3.71,2.47,9.03,6.49,10.43,1.47.51,3.65.58,4.94-.73,1.6-1.6,1.56-4.89-.11-6.12-1.6-1.18-4.23-.16-5.65,1.13-3,2.69-2.25,8.01-1.62,11.96,1.65,10.34,6.23,14.01,4.36,16.57-1.71,2.33-7.56,2.05-11.14-.89-3.29-2.69-4.94-7.81-3.2-10.05,1.47-1.89,4.38.51,9.83-1.56,1.8-.69,2.58-1.36,5.36-2.22,1.85-.58,3.05-.93,4.69-1.07,3.8-.27,5.96,1.07,7.05-.16.31-.33.33-.6.49-1.53.33-1.93,1.18-5.27,2.94-6.36,1.6-1,4.03-1.11,5.69,0,2.47,1.65,2.31,5.23,2.22,6.85-.07,1.27-.4,2.36-.4,2.36-.58,2.11-1.36,2.74-1.11,3.6.31,1.16,2.09,1.56,2.89,1.8,5.83,1.65,9.47,7.67,9.94,8.43,2.11,3.47,3.34,8.9,1.05,11.21-.07.07-1.38,1.36-2.8,1.02-2.51-.56-1.85-5.23-4.51-8.43-4.03-4.83-14.5-4.98-17.21-.96-1.22,1.82-1.11,4.89.31,6.23,1.45,1.36,3.25-.07,5.92,1.33,2.25,1.18,1.82,2.62,4.09,4.14,3.22,2.16,6.18.67,6.8,1.98.78,1.62-3.36,5.89-7.92,8.52-3.85,2.22-7.87,3.18-7.72,3.96.07.27.62.38,1.09.44,3.51.51,6.18.91,9.3-.49,2.94-1.33,4.47-3.45,6.36-2.74.11.04.18.07.31.13,1.47.76,2.42,2.71,6.94,8.58,1.82,2.36,2.8,3.54,3.14,3.98,7.98,10.45,7.58,78.12,7.58,87.35,0,8.54.4,21.62,2.56,37.8,2.16,8.52,4.01,18.09,5.15,28.6,2.75,25.41.35,47.4-2.99,64.03"
            style={{ pathLength: createPathAnimation(0, 0) }}
          />
          <motion.path
            className="cls-1"
            d="M63.15,3106.06c-3.38-.09-14.14.19-22.9,11.12-8.56,10.71-10.1,25.1-10.79,31.72-.29,2.74-.85,8.82.51,24,1.56,17.58,3.91,28,5.74,38.68,0,0,4.11,24.22,4.54,51.4.22,13.48-.42,32.76-4.47,55.97"
            style={{ pathLength: createPathAnimation(0, 0) }}
          />
          <motion.path
            className="cls-1"
            d="M251.9,3106.43c-24.39-1.87-44.23-1.49-57.6-.85,0,0-87.28,4.31-126.29,1.02-7.34-.62-14.3-2.02-18.75-7.03-1.4-1.58-2.49-3.45-6.27-7.87-3.07-3.6-5.63-6.2-6.54-7.12-6.69-6.74-13.52-13.7-17.03-11.76-1.65.91-1.96,3.74-5.09,4.91-1.69.62-2.87.27-3.2,1-.53,1.18,2.42,2.47,3.58,5.6,1.38,3.8-.73,8.05-1.33,9.21-1.96,3.89-4.56,4.85-4.09,6.94.24,1.05.96,1.09,2.78,3.65,1.38,1.96,2.09,2.94,1.82,3.6-.4,1-6.91.98-13.72.73"
            style={{ pathLength: createPathAnimation(0, 0) }}
          />
          <motion.path
            className="cls-1"
            d="M393.17,3108.23c-12.81-1.78-33.7-2.16-41.29-2.13-9.74.04-14.61.07-17.37.62-5.72,1.16-12.25,3.54-19.95,1.58-1.33-.33-2.18-.67-2.38-.76-4.63-1.87-10.47-6.56-10.39-12.34.02-2.22.93-3.85,1.8-5.47,2.96-5.38,7.65-7.12,7.41-7.54-.31-.56-8.83.64-12.19,7.23-3.11,6.05.07,12.3.33,12.83,1.96,3.69,4.2,4.58,4,5.63-.42,2.16-11.23,2.96-51.26-1.42"
            style={{ pathLength: createPathAnimation(0, 0) }}
          />
          <motion.path
            className="cls-1"
            d="M285.72,3290.3c1.11-6.52,3.45-9.07,5.56-10.12,2.13-1.05,4.63-.87,4.98-2.22.31-1.16-1.36-1.85-2.4-4.76-.4-1.09-.96-2.67-.47-4.43.53-1.93,2.31-3.91,4.49-4.2,2.94-.4,5.56,2.51,6.65,4.54,1.51,2.78.51,4.49,1.93,5.47,1.96,1.33,4.38-1.58,7.67-.47,2.71.91,3.74,3.78,4.4,3.42.51-.27.31-2.16-.47-3.76-1.53-3.11-4.09-2.62-6.14-5.56-1.58-2.25-2.29-5.69-.85-7.72.62-.87,1.45-1.22,1.73-1.33,2.89-1.09,6.85,1.6,6.67,3.22-.18,1.76-5.27,2.54-5.8,2.6-7.85,1.09-17.97-4.49-23.06-12.83-6.38-10.5-.51-18.24-2.87-39.32-1.09-9.81-3.45-17.68-5.27-22.86-17.23-47.97-18.64-85.37-16.63-110.92,0,0,7.49-95.82.98-132.69-.02-.16-.07-.4-.16-.85-2.87-16.26-3.74-29.02-4-33.33-1.36-22.28.31-42.9,3.6-52.26.76-2.18,3.49-9.16,6.07-12.56.11-.13,1.58-2.07,3.31-4.63.51-.76,1-1.49,1.56-2.4,3-4.89,2.76-5.89,5.52-10.3,2.22-3.54,3.87-6.09,7.07-8.12,1.67-1.05,5.11-3.22,7.87-1.85,2.51,1.27,3.6,5.09,2.76,5.8-.64.56-2.45-.62-3.85-1.51-2.36-1.51-8.92-5.74-9.76-13.03-.31-2.65.27-4.65.8-6.49,1.47-5.18,4-6.76,9.34-15.83,1.45-2.45,2.33-4.16,2.13-6.36-.27-3-2.4-5.16-3.31-5.94-.04-.04-.16-.13-.31-.27-19.24-16.26-49.66,2.62-101.98,7.96-20.24,2.07-30.4,3.11-44.9.85-14.23-2.22-24.11-6.29-43.83-6.34-3.18,0-21.86.13-26.57,8.12-.53.91-2.02,3.42-1.2,5.83,1.18,3.45,6.05,3.69,5.96,5.34-.11,2-6.69,4.47-8.94,2.36-1.18-1.11-.16-2.58-1.49-4.91-.96-1.67-3.11-3.76-5.69-3.54-2.47.2-3.94,2.36-4.18,2.71-.18.27-1.09,1.67-1.11,3.58,0,1.38.44,2.4,1.02,3.76.96,2.2,1.58,2.36,1.6,3.51.04,1.49-.93,2.65-1.47,3.29-1.38,1.65-2.42,1.51-3.82,2.69-2.6,2.2-2.76,5.92-2.78,6.43-.11,3.58,2,6.07,2.91,7.16.8.96,3.27,3.62,8.98,5.03,9.36,2.33,22.19-.04,23.55-5.69.51-2.16-.67-4.76-2.49-6.14-4.45-3.36-10.54,1.89-18.21,2.56-14.74,1.29-30.58-18.01-37.27-33.38-5.45-12.5-5.2-25.02-4.74-50.1.07-3.91.31-8.45.31-8.45.3-4.27.56-8.59.77-12.97.82-16.52.96-32.43.58-47.67.08-9.83.27-19.8.6-29.92.92-28.7,2.79-56.26,5.39-82.59"
            style={{ pathLength: createPathAnimation(0, 0) }}
          />
          <motion.path
            className="cls-1"
            d="M205.82,3324.53c7.32-38.27,7.41-68.78,6.03-89.81-1.47-22.65-3.05-19.45-6.96-56.14-4.2-39.5-2.78-51.73-7.61-85.12-.62-4.25-1.87-12.26-3.07-23.7-5.74-53.98-3.62-88.2-2.51-142.24.44-21.83,0-18.56.36-59.08.22-25.53.49-47.77.62-57.78.85-59.62,4.2-94.72,4.36-144.4.09-25-.62-60.7-4.34-104.16"
            style={{ pathLength: createPathAnimation(0, 0) }}
          />
          <motion.path
            className="cls-1"
            d="M131.97,3324.93c-8.27-19.46-11.23-35.79-12.43-46.97-1.8-16.94.62-20.65-2.6-37.45-2.2-11.54-4.83-17.55-7.92-35.57,0,0-2.56-15,.73-26.02.69-2.33,1.6-4.48,1.6-4.48,1.27-2.66,2.33-4.79,3.27-6.28,5.05-8.06,19.17-25.85,21.37-23.67.36.33.58,1.33,2.18,3.82.47.72,2.09,3.21,4.6,5.09,3.69,2.77,5.6,1.49,6.98,4.12.49.94.78,1.77,1.78,3.9.31.66.73,1.41,1.36,2.3,1.05,1.47,1.8,2.19,1.62,2.93-.27,1.11-2.29.8-4.76,1.74-2.11.8-3.45,2.13-5.18,3.85-3.65,3.63-5.47,7.89-6.85,11.18-2.91,6.95-1.76,8.11-4.29,12.57-3.05,5.31-6.34,6.48-5.89,8.19.38,1.52,3.67,1.58,10.23,1.58,6.18,0,7.36-.53,7.72-1.08.07-.11.09-.17.09-.19.04-.11-5.18-7.78-7.67-10.05-18.19-16.5-79.3-7.03-79.3-7.03-21.57,0-18.08,7.94-58.44,4.9"
            style={{ pathLength: createPathAnimation(0, 0) }}
          />
        </svg>
      </motion.div>
    </div>
  );
}
